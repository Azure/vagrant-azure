{
  "$schema": "http://schema.management.azure.com/schemas/2014-04-01-preview/deploymentTemplate.json",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "adminUserName": {
      "type": "string",
      "defaultValue": "vagrant",
      "metadata": {
        "description": "User name for the Virtual Machine."
      }
    },
    <% if operating_system == 'Windows' %>
    "adminPassword": {
      "type": "securestring",
      "metadata": {
        "description": "Password for the Virtual Machine (only used on Windows)"
      }
    },
    <% else %>
    "sshKeyData": {
      "type": "string",
      "metadata": {
        "description": "SSH rsa public key file as a string."
      }
    },
    <% end %>
    "dnsLabelPrefix": {
      "type": "string",
      "metadata": {
        "description": "Unique DNS Name for the Public IP used to access the Virtual Machine."
      }
    },
    "nsgLabelPrefix": {
      "type": "string",
      "metadata": {
        "description": "Network Security Group Label Prefix for the Virtual Machine."
      }
    },
    "vmSize": {
      "type": "string",
      "defaultValue": "Standard_DS2_v2",
      "metadata": {
        "description": "Size of the VM"
      }
    },
    "vmName": {
      "type": "string",
      "metadata": {
        "description": "Name of the VM"
      }
    },
    "imagePublisher": {
      "type": "string",
      "defaultValue": "canonical",
      "metadata": {
        "description": "Name of the image publisher"
      }
    },
    "imageOffer": {
      "type": "string",
      "defaultValue": "ubuntuserver",
      "metadata": {
        "description": "Name of the image offer"
      }
    },
    "imageSku": {
      "type": "string",
      "defaultValue": "16.04-LTS",
      "metadata": {
        "description": "Name of the image sku"
      }
    },
    "imageVersion": {
      "type": "string",
      "defaultValue": "latest",
      "metadata": {
        "description": "Name of the image sku"
      }
    },
    "subnetName": {
      "type": "string",
      "defaultValue": "vagrant-subnet",
      "metadata": {
        "description": "Name of the subnet"
      }
    },
    "virtualNetworkName": {
      "type": "string",
      "defaultValue": "vagrantVNET",
      "metadata": {
        "description": "Name of the virtual network"
      }
    },
    "winRmPort": {
      "type": "int",
      "defaultValue": 5986,
      "metadata": {
        "description": "WinRM port"
      }
    },
    "storageAccountType": {
      "type": "string",
      "defaultValue": "Premium_LRS",
      "metadata": {
        "description": "Storage account type for VM Disks"
      }
    }
  },
  "variables": {
    "storageAccountName": "[concat(uniquestring(resourceGroup().id), 'vagrant')]",
    "location": "[resourceGroup().location]",
    "osDiskName": "[concat(parameters('vmName'), 'OSDisk1')]",
    "managedOSDiskName": "[concat(parameters('vmName'), 'ManagedOSDisk')]",
    "sshKeyPath": "[concat('/home/',parameters('adminUsername'),'/.ssh/authorized_keys')]",
    "vmStorageAccountContainerName": "vagrant-vhds",
    "nicName": "[concat(parameters('vmName'), '-vagrantNIC')]",
    "publicIPAddressName": "[concat(parameters('vmName'), '-vagrantPublicIP')]",
    "publicIPAddressType": "Dynamic",
    "networkSecurityGroupName": "[concat(parameters('nsgLabelPrefix'), '-vagrantNSG')]",
    "addressPrefix": "10.0.0.0/16",
    "subnetPrefix": "10.0.0.0/24",
    "vnetID": "[resourceId('Microsoft.Network/virtualNetworks', parameters('virtualNetworkName'))]",
    "subnetRef": "[concat(variables('vnetID'),'/subnets/',parameters('subnetName'))]",
    "apiVersion": "2015-06-15",
    "singleQuote": "'",
    "doubleQuote": "\""
  },
  "resources": [
    <% if custom_image %>
    <%= VagrantPlugins::Azure::Util::TemplateRenderer.render("arm/resources/storage_account.json", self) + "," %>
    <% end %>
    <%= VagrantPlugins::Azure::Util::TemplateRenderer.render("arm/resources/network_security_group.json", self) + "," %>
    <%= VagrantPlugins::Azure::Util::TemplateRenderer.render("arm/resources/public_ip_address.json", self) + "," %>
    <%= VagrantPlugins::Azure::Util::TemplateRenderer.render("arm/resources/virtual_network.json", self) + "," %>
    <%= VagrantPlugins::Azure::Util::TemplateRenderer.render("arm/resources/network_interface.json", self) + "," %>
    <% if availability_set_name %>
      <%= VagrantPlugins::Azure::Util::TemplateRenderer.render("arm/resources/availability_set.json", availability_set_name: availability_set_name) + "," %>
    <% end %>
    <%= VagrantPlugins::Azure::Util::TemplateRenderer.render("arm/resources/virtual_machine.json", self) %>
  ]
}
